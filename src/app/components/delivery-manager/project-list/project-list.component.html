<div class="container-fluid px-4 resource-container">
  <div class="row mb-3 align-items-center">
    <div class="col text-color-secondary">
      <h4 class="page-title mt-3">Project List</h4>
    </div>
  </div>

  <div class="card shadow-sm rounded-4 border-0 resource-card">
    <div class="card-body">
      <div class="table-responsive mt-2">
        <table class="table table-striped align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">Project Code</th>
              <th scope="col">Project Name</th>
              <th scope="col">Customer Name</th>
              <th scope="col">Currency</th>
              <th scope="col">Start Date</th>
              <th scope="col">End Date</th>
              <th scope="col">Project Mgr</th>
              <th scope="col" class="ps-5">Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let proj of paginatedProjects; let i = index">
              <td>{{ proj.projectCode }}</td>
              <td>{{ proj.projectName }}</td>
              <td>{{ proj.customerName }}</td>
              <td>{{ proj.currency }}</td>
              <td>{{ proj.scheduleStartDate | date: 'mediumDate' }}</td>
              <td>{{ proj.scheduleEndDate | date: 'mediumDate' }}</td>
              <td>{{ proj.projectManager }}</td>
              <td>
                <div class="d-flex gap-2">
                  <button class="btn btn-sm icon-button" title="View" (click)="viewProjectDetails(proj)">
                    <i class="fa-regular fa-eye icon-action"></i>
                  </button>
                  <button class="btn btn-sm icon-button" title="Edit" (click)="editProject(i)" data-bs-toggle="modal"
                    data-bs-target="#projectFormModal">
                    <i class="fa-regular fa-pen-to-square icon-action"></i>
                  </button>

                  <button class="btn btn-sm icon-button" title="Configure Mail" (click)="configureEmailProject(proj)">
                    <i class="fa-solid fa-envelope-open-text"></i> </button>

                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Pagination -->
        <div class="d-flex justify-content-end align-items-center mt-3">
          <button class="btn btn-outline-secondary btn-sm me-2" (click)="prevPage()" [disabled]="currentPage === 1">
            &laquo; Prev
          </button>
          <span class="me-2">Page {{ currentPage }} of {{ totalPages }}</span>
          <button class="btn btn-outline-secondary btn-sm" (click)="nextPage()" [disabled]="currentPage === totalPages">
            Next &raquo;
          </button>
        </div>

        <ng-template #noData>
          <div class="text-center text-muted mt-3">No projects found.</div>
        </ng-template>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="projectDetailsModal" tabindex="-1" aria-labelledby="projectDetailsLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <!-- Header -->
      <div class="modal-header text-white cozentus-bg">
        <h5 class="modal-title" id="projectDetailsLabel">
          <i class="fa-regular fa-folder-open me-2"></i>Project Details
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Body -->
      <div class="modal-body bg-light-subtle px-4 py-4 rounded-bottom-4" *ngIf="selectedProject">
        <div class="row g-4">
          <div class="col-md-6" *ngFor="let field of [
              { icon: 'fa-code', label: 'Project Code', value: selectedProject.projectCode },
              { icon: 'fa-diagram-project', label: 'Project Name', value: selectedProject.projectName },
              { icon: 'fa-user-tie', label: 'Customer Name', value: selectedProject.customerName },
              { icon: 'fa-money-bill-wave', label: 'Currency', value: selectedProject.currency },
              { icon: 'fa-calendar-check', label: 'Start Date', value: (selectedProject.scheduleStartDate | date: 'mediumDate') },
              { icon: 'fa-calendar-xmark', label: 'End Date', value: (selectedProject.scheduleEndDate | date: 'mediumDate') }
            ]; let i = index">
            <div class="info-card h-100">
              <label><i class="fa-solid {{ field.icon }} me-1"></i> {{ field.label }}</label>
              <div>{{ field.value }}</div>
            </div>
          </div>

          <div class="col-12">
            <div class="info-card">
              <label><i class="fa-solid fa-user-gear me-1"></i> Project Manager</label>
              <div>{{ selectedProject.projectManager }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Email Modal -->
<div class="modal fade" id="mailModal" tabindex="-1" aria-labelledby="mailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content shadow-lg rounded-4">

      <div class="modal-header  border-0 rounded-top-4 px-4 py-3 cozentus-bg">
        <h5 class="modal-title fw-semibold text-light " id="mailModalLabel"> Configure Mail Notifications</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body px-4 py-4">

        <div class="row">
          <!-- Warn Mail Section -->
          <div class="col-md-6 border-end pe-4 ">
            <h6 class="fw-bold text-secondary mb-3 "> Warn Mail</h6>
            <div class="mb-3">
              <label class="form-label">Date</label>
              <input type="date" class="form-control rounded-3 shadow-sm" [(ngModel)]="warnMailDate">
            </div>
            <div class="mb-3">
              <label class="form-label">Time</label>
              <input type="time" class="form-control rounded-3 shadow-sm" [(ngModel)]="warnMailTime">
            </div>
          </div>

          <!-- Reminder Mail Section -->
          <div class="col-md-6 ps-4">
            <h6 class="fw-bold text-secondary mb-3"> Reminder Mail</h6>
            <div class="mb-3">
              <label class="form-label">Date</label>
              <input type="date" class="form-control rounded-3 shadow-sm" [(ngModel)]="reminderMailDate">
            </div>
            <div class="mb-3">
              <label class="form-label">Time</label>
              <input type="time" class="form-control rounded-3 shadow-sm" [(ngModel)]="reminderMailTime">
            </div>
          </div>
        </div>

      </div>

      <div class="modal-footer bg-light border-0 rounded-bottom-4 px-4 py-3 d-flex justify-content-between">
        <span class="text-muted small">Make sure the timings are valid before sending the mail.</span>
        <div>
          <button type="button" class="btn btn-secondary px-4" (click)="sendEmail()">
            <i class="fa-solid fa-paper-plane me-2"></i>Send Email
          </button>
          <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Close</button>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="projectFormModal" tabindex="-1" aria-labelledby="projectFormLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <!-- Header -->
      <div class="modal-header text-white cozentus-bg">
        <h5 class="modal-title" id="projectFormLabel">
          <i class="fa-regular fa-folder-open me-2"></i>Edit Project
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Progress Steps -->
      <div class="bg-white px-4 py-3 border-bottom">
        <div class="d-flex justify-content-center">
          <div class="d-flex align-items-center gap-3">
            <!-- Step 1 -->
            <div class="d-flex align-items-center">
              <div class="step-circle" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
                <i class="fa-solid" [ngClass]="currentStep > 1 ? 'fa-check' : 'fa-info'"></i>
              </div>
              <span class="ms-2 fw-medium" [class.text-primary]="currentStep === 1">Project Details</span>
            </div>

            <div class="step-line"></div>

            <!-- Step 2 -->
            <div class="d-flex align-items-center">
              <div class="step-circle" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">
                <i class="fa-solid" [ngClass]="currentStep > 2 ? 'fa-check' : 'fa-users'"></i>
              </div>
              <span class="ms-2 fw-medium" [class.text-primary]="currentStep === 2">Customer Info</span>
            </div>

            <div class="step-line"></div>

            <!-- Step 3 -->
            <div class="d-flex align-items-center">
              <div class="step-circle" [class.active]="currentStep === 3">
                <i class="fa-solid fa-user-tie"></i>
              </div>
              <span class="ms-2 fw-medium" [class.text-primary]="currentStep === 3">Project Manager</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Body -->
      <div class="modal-body bg-light-subtle px-4 py-4" style="min-height: 500px;">
        <form [formGroup]="projectForm" (ngSubmit)="onSubmit()">

          <!-- Step 1: Project Details -->
          <div *ngIf="currentStep === 1">
            <h4 class="mb-4">Project Details</h4>
            <div class="row g-4">
              <!-- Project Code -->
              <div class="col-md-6">
                <div class="form-floating form-floating-custom">
                  <input type="text" class="form-control" id="projectCode" placeholder="Project Code"
                    formControlName="projectCode">
                  <label for="projectCode">Project Code*</label>
                </div>
              </div>

              <!-- Project Name -->
              <div class="col-md-6">
                <div class="form-floating form-floating-custom">
                  <input type="text" class="form-control" id="projectName" placeholder="Project Name"
                    formControlName="projectName">
                  <label for="projectName">Project Name*</label>
                </div>
              </div>

              <!-- Currency -->
              <div class="col-md-6">
                <div class="form-floating form-floating-custom">
                  <select class="form-select" id="currency" formControlName="currency">
                    <option value="">Select currency</option>
                    <option value="USD">USD - US Dollar</option>
                    <option value="EUR">EUR - Euro</option>
                    <option value="GBP">GBP - British Pound</option>
                    <option value="INR">INR - Indian Rupee</option>
                    <option value="JPY">JPY - Japanese Yen</option>
                    <option value="CAD">CAD - Canadian Dollar</option>
                    <option value="AUD">AUD - Australian Dollar</option>
                  </select>
                  <label for="currency">Currency*</label>
                </div>
              </div>

              <!-- Start Date -->
              <div class="col-md-6">
                <div class="form-floating form-floating-custom">
                  <input type="date" class="form-control" id="scheduleStartDate" formControlName="scheduleStartDate">
                  <label for="scheduleStartDate">Start Date*</label>
                </div>
              </div>

              <!-- End Date -->
              <div class="col-md-6">
                <div class="form-floating form-floating-custom">
                  <input type="date" class="form-control" id="scheduleEndDate" formControlName="scheduleEndDate">
                  <label for="scheduleEndDate">End Date*</label>
                </div>
              </div>

                              <div class="col-md-6">
                  <div class="form-floating form-floating-custom">
                    <select class="form-select" id="contractType" formControlName="contractType">
                      <option value="">Select contract type</option>
                      <option value="Fixed Price">Fixed Price</option>
                      <option value="Time & Material">Time & Material</option>
                      <option value="Cost Plus">Cost Plus</option>
                    </select>
                    <label for="contractType">Contract Type</label>
                  </div>
                </div>
            </div>
          </div>

          <!-- Step 2: Customer Info -->
          <div *ngIf="currentStep === 2" formGroupName="customerInfo">
            <h4 class="mb-4">Customer Info</h4>

            <!-- Select Type Buttons + Search Bar -->
            <div class="mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
              <!-- Tab Buttons -->
              <div class="tab-buttons d-flex gap-2">
                <button type="button" class="tab-button" [class.active]="!isNewCustomer"
                  (click)="setCustomerType(false)">
                  Existing
                </button>
                <button type="button" class="tab-button" [class.active]="isNewCustomer" (click)="setCustomerType(true)">
                  New
                </button>
              </div>

              <!-- Search bar -->
              <div *ngIf="!isNewCustomer" class="search-container">
                <input type="text" class="form-control" placeholder="Search customers..." [value]="customerSearchText"
                  (input)="customerSearchText = $any($event.target).value" />
              </div>
            </div>

            <!-- Existing Customer Block -->
            <ng-container *ngIf="!isNewCustomer">
              <div class="customer-list-container" style="max-height: 350px; overflow-y: auto;">
                <div *ngFor="let customer of filteredCustomers" class="card p-3 mb-3 border customer-card"
                  [class.border-success]="selectedCustomerId === customer.id"
                  [class.bg-light]="selectedCustomerId === customer.id">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <strong>{{ customer.name }}</strong><br />
                      <span class="text-muted">{{ customer.legalEntity }} | {{ customer.contractType }}</span>
                    </div>
                    <button type="button" class="btn btn-sm" [ngClass]="{
                              'btn-success text-white': selectedCustomerId === customer.id,
                              'btn-outline-primary': selectedCustomerId !== customer.id
                            }" (click)="selectCustomer(customer)">
                      <i class="fa-solid"
                        [ngClass]="selectedCustomerId === customer.id ? 'fa-check-circle' : 'fa-plus-circle'">
                      </i>
                    </button>
                  </div>
                </div>
              </div>
            </ng-container>

            <!-- New Customer Block -->
            <ng-container *ngIf="isNewCustomer">
              <div class="row g-4">
                <div class="col-md-6">
                  <div class="form-floating form-floating-custom">
                    <input type="text" class="form-control" id="custName" placeholder="Customer Name"
                      formControlName="name" />
                    <label for="custName">Customer Name*</label>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="form-floating form-floating-custom">
                    <input type="text" class="form-control" id="legalEntity" placeholder="Legal Entity"
                      formControlName="legalEntity" />
                    <label for="legalEntity">Legal Entity*</label>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="form-floating form-floating-custom">
                    <input type="text" class="form-control" id="businessUnit" placeholder="Business Unit"
                      formControlName="businessUnit" />
                    <label for="businessUnit">Business Unit</label>
                  </div>
                </div>


              </div>
            </ng-container>
          </div>

          <!-- Step 3: Project Manager -->
          <div *ngIf="currentStep === 3">
            <!-- Title and Search -->
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4 class="mb-0 me-3 flex-grow-1">Select Project Manager</h4>
              <input type="text" class="form-control manager-search" style="max-width: 300px;"
                placeholder="Search managers..." [value]="managerSearchText"
                (input)="managerSearchText = $any($event.target).value" />
            </div>

            <!-- Scrollable list of managers -->
            <div class="manager-list-container" style="max-height: 400px; overflow-y: auto;">
              <div *ngFor="let manager of filteredManagers" class="card p-3 mb-3 border manager-card cursor-pointer"
                [class.bg-light-blue]="selectedManagerId === manager.id"
                [class.border-primary]="selectedManagerId === manager.id" (click)="selectManager(manager.id)">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="flex-grow-1">
                    <h5 class="mb-2">{{ manager.name }}</h5>
                    <p class="mb-1"><strong>Email:</strong> {{ manager.email }}</p>
                    <p class="mb-1"><strong>Projects Involved:</strong> {{ manager.projects?.length || 0 }}</p>
                    <div *ngIf="manager.projects?.length">
                      <small class="text-muted">{{ manager.projects.join(', ') }}</small>
                    </div>
                  </div>
                  <div>
                    <input class="form-check-input" type="radio" [checked]="selectedManagerId === manager.id"
                      name="managerId" [value]="manager.id" (click)="$event.stopPropagation()" />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Footer -->
      <div class="modal-footer bg-white border-top">
        <div class="d-flex justify-content-between w-100">
          <!-- Previous Button -->
          <button type="button" class="btn btn-outline-secondary" [disabled]="currentStep === 1"
            (click)="previousStep()">
            <i class="fa-solid fa-chevron-left me-1"></i> Previous
          </button>

          <div class="d-flex gap-2">
            <!-- Cancel Button -->
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fa-solid fa-xmark me-1"></i> Cancel
            </button>

            <!-- Next/Save Button -->
            <button type="button" class="btn btn-custom-primary" *ngIf="currentStep < 3" (click)="nextStep()">
              Next <i class="fa-solid fa-chevron-right ms-1"></i>
            </button>

            <button type="button" class="btn btn-success" *ngIf="currentStep === 3" (click)="onSubmit()">
              <i class="fa-solid fa-check me-1"></i> Save Project
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

